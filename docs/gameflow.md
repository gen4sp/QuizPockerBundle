# Алгоритм игрового процесса

## Создание и подготовка игры

### 1. Создание игры

-   Создатель игры задает настройки:
    -   Начальный стек игроков (по умолчанию 100)
    -   Минимальная ставка (анте) (по умолчанию 5)
    -   Время на ход (по умолчанию 30 секунд)
    -   Максимальное количество раундов (по умолчанию 10)
    -   Минимальное/максимальное количество игроков (2-8)
    -   Условие победы (ближайший к ответу или ближайший, но не превышающий)

### 2. Ожидание игроков

-   Игроки присоединяются к игре по коду
-   Каждый игрок получает начальный стек
-   Создатель может изменять настройки до начала игры

### 3. Запуск игры

-   Создатель запускает игру (минимум 2 игрока)
-   Игра переходит в статус "playing"
-   Начинается первый раунд

## Структура раунда

Каждый раунд проходит через следующие фазы:

### Фаза 1: Автоматические анте-ставки (`ante`)

-   Все активные игроки автоматически делают минимальную ставку
-   Если у игрока недостаточно фишек для анте, он делает ставку all-in
-   Если игрок не может поставить минимальную ставку, он выбывает из раунда
-   Все ставки суммируются в общий банк раунда

### Фаза 2: Показ вопроса (`question1`)

-   Всем игрокам показывается основной (сложный) вопрос
-   Вопрос требует численного ответа
-   Игроки должны дать ответ в течение 30 секунд
-   Ответы остаются скрытыми от других игроков

### Фаза 3: Первый круг ставок (`betting1`)

-   Игроки делают ставки по очереди (начиная с позиции после дилера)
-   Доступные действия:
    -   **Check** — остаюсь в игре без дополнительной ставки (если никто не повысил)
    -   **Call** — уравниваю текущую ставку
    -   **Raise** — повышаю ставку
    -   **All-in** — ставлю все оставшиеся фишки
    -   **Fold** — сбрасываю карты и выхожу из раунда
-   Если игрок не делает ставку в течение времени — автоматический fold
-   Круг продолжается пока все не уравняют ставки или не сбросят карты

### Фаза 4: Показ подсказки (`question2`)

-   Показывается подсказка — более простая версия того же вопроса
-   Игроки могут скорректировать свои ответы (опционально)

### Фаза 5: Второй круг ставок (`betting2`)

-   Аналогичен первому кругу ставок
-   Игроки могут изменить свою стратегию на основе подсказки

### Фаза 6: Показ правильного ответа (`reveal`)

-   Открывается правильный ответ на вопрос
-   Вычисляется точность ответов каждого игрока (отклонение от правильного ответа)

### Фаза 7: Финальный круг ставок (`betting3`)

-   Последний шанс сделать ставки, зная правильный ответ
-   Игроки оценивают свои шансы на победу

### Фаза 8: Открытие ответов (`showdown`)

-   Открываются ответы всех активных игроков
-   Определяется победитель(и) по условию игры:
    -   **Closest** — ближайший к правильному ответу
    -   **Closest not over** — ближайший, но не превышающий правильный ответ
-   Банк распределяется между победителями

### Фаза 9: Завершение раунда (`finished`)

-   У создателя игры появляется кнопка "Следующий вопрос"
-   Обновляются стеки игроков
-   Игроки с нулевым стеком выбывают из игры

## Переход к следующему раунду

### Условия для следующего раунда:

-   Остается минимум 2 активных игрока
-   Не достигнуто максимальное количество раундов
-   Создатель инициирует следующий раунд

### Изменения в новом раунде:

-   Минимальная ставка увеличивается: `ante × 2^(roundNumber-1) или ante*(roundNumber)`
-   Позиция дилера смещается на одну позицию
-   Выбирается новый случайный вопрос
-   Сбрасываются все текущие ставки игроков

## Распределение банка

### Один победитель:

-   Получает весь банк раунда

### Несколько победителей:

-   Банк делится пропорционально точности ответов
-   Игрок с более точным ответом получает большую долю
-   При одинаковой точности банк делится поровну

### Формула распределения:

```
accuracyScore = max(0, 100 - |correctAnswer - playerAnswer|)
playerShare = (playerAccuracyScore / totalAccuracyScore) × totalPot
```

## Завершение игры

### Игра завершается когда:

-   Остался только один игрок с фишками (он побеждает)
-   Достигнуто максимальное количество раундов
-   Создатель принудительно завершает игру

### Определение общего победителя:

-   Игрок с наибольшим количеством фишек
-   При равенстве — несколько победителей

## Особенности реализации

### Таймеры:

-   30 секунд на ответ на вопрос
-   30 секунд на каждое действие в торгах
-   При истечении времени — автоматические действия (fold для ставок)

### Позиции игроков:

-   Фиксированные позиции за столом (0 до maxPlayers-1)
-   Порядок ходов определяется позицией дилера
-   Дилер меняется каждый раунд

### Стеки и ставки:

-   Стек игрока не может быть отрицательным
-   All-in доступен всегда (ставка всех оставшихся фишек)
-   Минимальная ставка не может превышать стек игрока

### Вопросы:

-   Система выбора вопросов внешняя и ни как не влияет на текущую логику
